# 印刷テスト整理計画

## 現状の問題点

### 1. テスト構成の課題
- ❌ テストファイルが機能別に分散（6ファイル、69テスト）
- ❌ `WordEnLayout.test.tsx`が他のレイアウトテストと分離
- ❌ `PrintLayout.test.tsx`が実装と乖離したDOM生成ロジックを持つ
- ❌ 同じ機能を異なるファイルでテスト（A4判定を3箇所）

### 2. テストの重複
- `print-validator.test.ts`の`estimateA4Fit()`
- `print-templates.test.ts`の`fitsInA4()`
- `WordEnLayout.test.tsx`の暗黙的なA4判定

### 3. 欠けているテストケース
- 実際のPDF生成テスト（Playwrightで可能）
- 大量問題数（100問+）のパフォーマンステスト
- react-to-print v3の印刷プレビュー統合テスト
- アクセシビリティ（印刷プレビューのキーボード操作）

## 整理後の構成

### レイヤー1: 設定・ロジック層
**目的**: ビジネスロジックの単体テスト

#### `src/config/__tests__/print-templates.test.ts` (20テスト)
- ✅ 維持：テンプレート定義の完全性
- ✅ 維持：推奨問題数の妥当性
- ✅ 維持：レイアウト最適化の検証

#### `src/lib/utils/__tests__/print-validator.test.ts` (18テスト → 15テスト)
- ✅ 維持：HTML解析ロジック
- ✅ 維持：問題タイプ検証
- ❌ 削除：`estimateA4Fit()`の重複テスト（print-templatesに統合）

### レイヤー2: コンポーネント統合層
**目的**: Reactコンポーネントの統合テスト

#### `src/components/Export/__tests__/print-integration.test.tsx` (新規作成、20テスト)
統合テストファイルとして以下を統合：
- `PrintLayout.test.tsx` (10テスト) - ❌ 削除
- `WordEnLayout.test.tsx` (4テスト) - ❌ 削除
- 新規テスト (6テスト):
  - すべての問題タイプの統合レンダリング
  - react-to-printとの統合
  - 動的余白計算の検証

#### `src/components/Export/__tests__/PrintButton.test.tsx` (8テスト)
- ✅ 維持：単一ページ印刷ボタン
- 🔄 改善：react-to-print v3 APIとの統合を明示的にテスト

#### `src/components/Export/__tests__/MultiPrintButton.test.tsx` (9テスト)
- ✅ 維持：複数ページ印刷ボタン
- 🔄 改善：react-to-print v3 APIとの統合を明示的にテスト

### レイヤー3: E2E層（新規）
**目的**: 実際のブラウザでの印刷動作テスト

#### `e2e/print.spec.ts` (新規作成、8テスト)
Playwright MCPを使用した実際の印刷テスト：
1. PDF生成の成功確認
2. 印刷プレビューの表示確認
3. 各問題タイプのレイアウト検証
4. A4サイズへの収まり確認（実際のピクセル計測）
5. 複数ページ印刷の改ページ確認
6. アクセシビリティ（キーボード操作）
7. パフォーマンス（100問の生成・印刷時間）
8. ブラウザ互換性（Chrome, Firefox, Safari）

## 実装計画

### Phase 1: テスト統合（優先度：高）
1. `print-integration.test.tsx`を作成
2. `PrintLayout.test.tsx`と`WordEnLayout.test.tsx`を統合
3. 重複テストを削除
4. 既存テストが100%パスすることを確認

### Phase 2: テスト改善（優先度：中）
1. react-to-print v3統合テストを追加
2. 動的余白計算のテストを追加
3. すべての問題タイプのレンダリングテストを追加

### Phase 3: E2Eテスト追加（優先度：中）
1. Playwright設定ファイル作成
2. 基本的な印刷E2Eテストを作成
3. アクセシビリティテストを追加
4. パフォーマンステストを追加

### Phase 4: ドキュメント整備（優先度：低）
1. テスト実行ガイドを作成
2. 新しいテストケース追加ガイドを作成
3. テストカバレッジレポートの自動生成

## テスト削減・統合の詳細

### 削除するテスト
1. **print-validator.test.ts**:
   - `estimateA4Fit()` テスト（6テスト）→ print-templates.test.tsに統合済み

### 統合するテスト
1. **PrintLayout.test.tsx** + **WordEnLayout.test.tsx** → **print-integration.test.tsx**
   - DOM構造テスト
   - 問題順序テスト
   - 問題タイプ別レンダリング
   - 2列・3列レイアウト

### 新規追加するテスト
1. **print-integration.test.tsx**:
   - react-to-print v3統合（2テスト）
   - 動的余白計算（2テスト）
   - すべての問題タイプ統合（2テスト）

2. **e2e/print.spec.ts**:
   - 実際のPDF生成（8テスト）

## 期待される効果

### テストメンテナンス性
- ✅ テストファイル数: 6 → 4 (-33%)
- ✅ テスト総数: 69 → 65 (-6%)
- ✅ 重複テスト削除: 4テスト
- ✅ レイヤー分離による保守性向上

### テストカバレッジ
- ✅ 実際の印刷動作をテスト（PDF生成）
- ✅ react-to-print v3統合を明示的にテスト
- ✅ アクセシビリティテストを追加
- ✅ パフォーマンステストを追加

### 開発体験
- ✅ テスト実行時間: 約1.9秒 → 約1.5秒 (-20%)
- ✅ テストの意図が明確になる
- ✅ 新しいテスト追加が容易になる

## 実装スケジュール

| Phase | 作業内容 | 所要時間 | 完了条件 |
|-------|---------|---------|---------|
| Phase 1 | テスト統合 | 2時間 | 全テスト100%パス |
| Phase 2 | テスト改善 | 1時間 | カバレッジ維持 |
| Phase 3 | E2E追加 | 3時間 | E2Eテスト実行可能 |
| Phase 4 | ドキュメント | 1時間 | README更新 |

**合計所要時間**: 約7時間

## 注意事項

### 既存テストの削除タイミング
1. 新しい統合テストが100%パスすることを確認
2. すべての既存テストケースが新しいテストでカバーされていることを確認
3. git履歴でいつでも戻せることを確認

### E2Eテストの実行環境
1. Playwright MCPは開発環境でのみ実行
2. CIでの実行は別途設定が必要
3. ブラウザ互換性テストはローカルでのみ実行

### 後方互換性
1. react-to-print v3のAPI変更に注意
2. 既存の印刷機能に影響がないことを確認
3. すべての問題タイプで印刷が正常に動作することを確認
